---
phase: 02-batch-ui
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - index.html
  - src/index.css
  - src/lib/theme.ts
  - src/components/ThemeToggle.tsx
  - src/components/BackgroundToggle.tsx
  - src/components/BatchProgress.tsx
  - src/components/ImageCard.tsx
  - src/components/BeforeAfter.tsx
  - src/components/ImageGrid.tsx
  - src/components/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle between transparent (PNG) and white (JPG) background and see preview update instantly"
    - "User can compare before/after for each processed image via slider"
    - "Checkerboard pattern visible behind transparent areas in preview"
    - "Dark/light theme toggle persists across sessions with no FOUC"
    - "Layout is responsive: 1 column on mobile, 2 on tablet, 3+ on desktop"
    - "Overall batch progress shown: 'X of Y processed' with progress bar"
    - "Each image card shows status badge (Waiting/Processing/Done/Error)"
    - "Professional, modern visual design with smooth transitions"
  artifacts:
    - path: "src/components/ImageGrid.tsx"
      provides: "Responsive CSS Grid layout for image cards"
      contains: "auto-fill"
    - path: "src/components/ImageCard.tsx"
      provides: "Per-image card with status, preview, actions"
      contains: "ImageItem"
    - path: "src/components/BeforeAfter.tsx"
      provides: "Before/after slider comparison using CSS clip-path"
      contains: "clip-path"
    - path: "src/components/BatchProgress.tsx"
      provides: "Overall batch progress bar with counts"
      contains: "processed"
    - path: "src/components/BackgroundToggle.tsx"
      provides: "Transparent/white background mode toggle"
      contains: "BackgroundMode"
    - path: "src/components/ThemeToggle.tsx"
      provides: "Dark/light theme toggle with localStorage persistence"
      contains: "localStorage"
    - path: "src/lib/theme.ts"
      provides: "Theme utility functions"
      contains: "theme"
    - path: "src/index.css"
      provides: "Tailwind dark mode custom-variant + checkerboard CSS"
      contains: "@custom-variant dark"
    - path: "index.html"
      provides: "Sync theme script preventing FOUC"
      contains: "localStorage.theme"
  key_links:
    - from: "src/components/App.tsx"
      to: "src/components/ImageGrid.tsx"
      via: "passes images array and handlers"
      pattern: "ImageGrid"
    - from: "src/components/ImageGrid.tsx"
      to: "src/components/ImageCard.tsx"
      via: "maps over images, renders ImageCard per image"
      pattern: "ImageCard"
    - from: "src/components/ImageCard.tsx"
      to: "src/components/BeforeAfter.tsx"
      via: "renders BeforeAfter when status=done"
      pattern: "BeforeAfter"
    - from: "src/components/BackgroundToggle.tsx"
      to: "src/components/App.tsx"
      via: "dispatches SET_BACKGROUND_MODE"
      pattern: "SET_BACKGROUND_MODE"
    - from: "src/components/ThemeToggle.tsx"
      to: "index.html"
      via: "reads/writes localStorage.theme, toggles .dark class on html"
      pattern: "classList.*dark"
---

<objective>
Full UI layer: responsive image grid with per-image cards, before/after comparison slider, background mode toggle, dark/light theme with localStorage persistence and FOUC prevention, batch progress indicator, status badges, and professional visual polish.

Purpose: This plan transforms the minimal list UI from 02-01 into the polished, responsive interface that users actually interact with. All data/processing logic is already in place from 02-01 -- this plan is purely about presentation, interaction, and visual design.

Output: A complete, professional batch processing interface that works on desktop, tablet, and mobile, with dark/light theme, before/after previews, and smooth transitions.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-batch-ui/02-RESEARCH.md
@.planning/phases/02-batch-ui/02-01-SUMMARY.md
@src/lib/types.ts
@src/components/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme infrastructure, UI components, and responsive grid</name>
  <files>
    index.html
    src/index.css
    src/lib/theme.ts
    src/components/ThemeToggle.tsx
    src/components/BackgroundToggle.tsx
    src/components/BatchProgress.tsx
    src/components/BeforeAfter.tsx
    src/components/ImageCard.tsx
    src/components/ImageGrid.tsx
  </files>
  <action>
1. **`index.html`** -- Add synchronous theme detection script in `<head>` BEFORE the coi-serviceworker script to prevent FOUC:
   ```html
   <script>
     document.documentElement.classList.toggle(
       "dark",
       localStorage.theme === "dark" ||
         (!("theme" in localStorage) &&
           window.matchMedia("(prefers-color-scheme: dark)").matches)
     );
   </script>
   ```
   This runs synchronously before any rendering, preventing the white flash.

2. **`src/index.css`** -- Extend with Tailwind v4 dark mode and checkerboard:
   ```css
   @import "tailwindcss";
   @custom-variant dark (&:where(.dark, .dark *));

   :root {
     --checkerboard-light: #e5e7eb;
     --checkerboard-dark: #d1d5db;
   }
   .dark {
     --checkerboard-light: #374151;
     --checkerboard-dark: #1f2937;
   }

   .checkerboard {
     background-image:
       linear-gradient(45deg, var(--checkerboard-light) 25%, transparent 25%),
       linear-gradient(-45deg, var(--checkerboard-light) 25%, transparent 25%),
       linear-gradient(45deg, transparent 75%, var(--checkerboard-light) 75%),
       linear-gradient(-45deg, transparent 75%, var(--checkerboard-light) 75%);
     background-size: 20px 20px;
     background-position: 0 0, 0 10px, 10px -10px, -10px 0;
   }

   body {
     @apply bg-gray-50 font-sans antialiased dark:bg-gray-900;
   }
   ```

3. **`src/lib/theme.ts`** -- Theme utility:
   ```typescript
   export type Theme = "light" | "dark";

   export function getStoredTheme(): Theme | null {
     if (typeof window === "undefined") return null;
     const stored = localStorage.getItem("theme");
     return stored === "dark" || stored === "light" ? stored : null;
   }

   export function getEffectiveTheme(): Theme {
     const stored = getStoredTheme();
     if (stored) return stored;
     return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
   }

   export function applyTheme(theme: Theme): void {
     document.documentElement.classList.toggle("dark", theme === "dark");
     localStorage.setItem("theme", theme);
   }

   export function toggleTheme(): Theme {
     const current = getEffectiveTheme();
     const next: Theme = current === "dark" ? "light" : "dark";
     applyTheme(next);
     return next;
   }
   ```

4. **`src/components/ThemeToggle.tsx`** -- Dark/light toggle button:
   - Use `getEffectiveTheme()` for initial state (useState)
   - On click: call `toggleTheme()`, update local state
   - Render a button with sun/moon icon (inline SVG, no icon library)
   - Style: rounded pill shape, subtle border, icon transitions on hover
   - Dark mode: `dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700`

5. **`src/components/BackgroundToggle.tsx`** -- Transparent/white toggle:
   - Props: `mode: BackgroundMode`, `onChange: (mode: BackgroundMode) => void`
   - Two-button segmented control: "Transparent" | "White"
   - Active button has filled background, inactive is outlined
   - Small icons: checkerboard square for transparent, solid white square for white
   - Dark mode aware styling

6. **`src/components/BatchProgress.tsx`** -- Overall batch progress:
   - Props: `total: number`, `done: number`, `processing: number`, `errors: number`
   - Show "X of Y processed" text with optional error count in red
   - Progress bar: full width, rounded, Tailwind bg-blue-500 fill
   - Dark mode: `dark:bg-gray-700` for track
   - Only render when total > 0
   - Animate the progress bar width with `transition-[width] duration-300`

7. **`src/components/BeforeAfter.tsx`** -- Before/after comparison slider:
   - Props: `beforeUrl: string`, `afterUrl: string`, `alt: string`
   - CSS `clip-path: inset()` technique: "after" image shown full, "before" image clipped
   - Range input (0-100, default 50) controls clip position, styled as invisible overlay
   - Vertical divider line at slider position (white, thin, with subtle shadow)
   - "Before" / "After" labels at top-left and top-right, small text with semi-transparent background
   - Container: `relative overflow-hidden rounded-lg`
   - Both images use `class="block w-full h-auto"` for proper sizing
   - The checkerboard class on the container shows transparency in the "after" image

8. **`src/components/ImageCard.tsx`** -- Per-image card:
   - Props: `image: ImageItem`, `backgroundMode: BackgroundMode`, `onRetry: (id: string) => void`, `onRemove: (id: string) => void`
   - Card wrapper: rounded-xl, shadow-sm, border, background white/dark:gray-800, overflow-hidden
   - **Status states:**
     - `idle`/`queued`: Show original image thumbnail (via `image.originalUrl`), status badge "Waiting" / "Queued" in yellow
     - `processing`: Show original image with subtle pulse animation overlay, status badge "Processing..." in blue with spinner
     - `done`: Show BeforeAfter component with originalUrl as before and the appropriate result URL based on backgroundMode (resultUrl for transparent, resultWhiteUrl for white). Status badge "Done" in green.
     - `error`: Show original image, error message in red, retry button. Status badge "Error" in red.
   - Bottom bar: filename (truncated with ellipsis), status badge, action buttons (retry for error, remove X button always)
   - Status badge: small pill with colored background per status (see research Pattern for StatusBadge)
   - Transitions: fade in on mount (`animate-fadeIn` or Tailwind `animate-in`)
   - Dark mode: `dark:bg-gray-800 dark:border-gray-700`

9. **`src/components/ImageGrid.tsx`** -- Responsive grid:
   - Props: `images: ImageItem[]`, `backgroundMode: BackgroundMode`, `onRetry: (id: string) => void`, `onRemove: (id: string) => void`
   - CSS Grid: `grid grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4`
   - Map over images, render ImageCard for each
   - When images is empty, render nothing (DropZone handles empty state)
   - Padding: `p-4` or `px-4` for outer spacing
  </action>
  <verify>
    Run `npx tsc -b` -- zero errors. Verify all 9 files exist:
    - index.html has theme script in head
    - src/index.css has @custom-variant dark
    - src/lib/theme.ts exports getEffectiveTheme, applyTheme, toggleTheme
    - All 6 component files exist and export their components
  </verify>
  <done>
    - Theme infrastructure: sync script in head (no FOUC), @custom-variant dark in CSS, theme.ts utilities, ThemeToggle component with sun/moon icons
    - BackgroundToggle: segmented control for transparent/white mode
    - BatchProgress: progress bar with "X of Y processed" text
    - BeforeAfter: CSS clip-path slider comparison with divider line
    - ImageCard: per-image card with status-dependent rendering, badges, retry/remove
    - ImageGrid: responsive CSS Grid with auto-fill minmax(280px, 1fr)
    - Checkerboard CSS class for transparent area visualization
    - All components dark mode aware
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire UI components into App.tsx with visual polish</name>
  <files>
    src/components/App.tsx
    src/components/DropZone.tsx
  </files>
  <action>
1. **Update `src/components/App.tsx`** -- Replace the minimal list UI from 02-01 with the full component tree:

   **Layout structure:**
   ```
   <div> (full-page container, min-h-screen, flex flex-col)
     <header> (top bar)
       - Logo/title "BatchClear.io" (left)
       - Controls (right): BackgroundToggle + ThemeToggle
     </header>
     <main> (flex-1, overflow-y-auto, p-4-6)
       - ModelProgress (when model downloading/loading)
       - DropZone (always visible when not at 100 images)
       - BatchProgress (when images.length > 0)
       - ImageGrid (when images.length > 0)
     </main>
     <footer> (optional: small text "Processed locally in your browser")
   </div>
   ```

   **Header:**
   - Sticky top, `bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-b`
   - Left: "BatchClear.io" logo text (text-xl font-bold) + subtitle "Background removal" (text-sm text-gray-500)
   - Right: BackgroundToggle (only show when images.length > 0 and at least one done) + ThemeToggle
   - Horizontal padding matching main content
   - Responsive: on mobile, stack controls below title if needed or keep inline with smaller spacing

   **DropZone placement:**
   - When no images: large, centered drop zone (current styling)
   - When images exist: compact drop zone at top of main area (smaller padding, single line of text "Drop more images or click to browse", max-height reduced)
   - Hide when at 100 images with message "Maximum 100 images reached"

   **Wire handlers:**
   - `onRetry` -> handleRetry from 02-01
   - `onRemove` -> dispatch REMOVE
   - BackgroundToggle onChange -> dispatch SET_BACKGROUND_MODE
   - BatchProgress: compute `done`, `processing`, `errors` from state.images using filter/count
   - Pass `state.backgroundMode` to ImageGrid -> ImageCard for correct preview URL selection

   **Remove the "Process another" single-image flow** -- this is now a batch app. Remove ResultView.tsx import and usage (the component itself can remain for now, 02-02 replaces its functionality with ImageCard).

   **Visual polish details:**
   - Smooth scroll behavior on main container
   - Subtle entrance animation on image cards (can be a simple CSS animation in index.css: `@keyframes fadeIn { from { opacity: 0; transform: translateY(8px) } to { opacity: 1; transform: translateY(0) } }`)
   - Status transitions: smooth color changes on badges
   - Error state: red border on card, error text below image
   - Loading state: subtle pulse or shimmer overlay on card image while processing
   - DropZone: when images exist, add a "Clear all" button next to the drop zone

   **Clear all handler:**
   - Dispatch CLEAR_ALL (reducer already revokes all Blob URLs)

2. **Update `src/components/DropZone.tsx`** -- Add compact mode:
   - Add prop: `compact: boolean` (default false)
   - When compact=true: reduce padding (p-4 instead of p-12), hide upload icon, single-line text, smaller browse button
   - When compact=false: keep current large centered layout
   - App.tsx passes `compact={state.images.length > 0}`

3. **Add CSS animation to `src/index.css`** (if not already):
   ```css
   @keyframes fadeInUp {
     from { opacity: 0; transform: translateY(8px); }
     to { opacity: 1; transform: translateY(0); }
   }
   .animate-fade-in-up {
     animation: fadeInUp 0.2s ease-out;
   }
   ```

4. **Remove the crossOriginIsolated indicator** from the bottom of the page (it was a Phase 1 debug tool, not needed in the production UI). The indicator was verified working in Phase 1.
  </action>
  <verify>
    Run `npx tsc -b` -- zero errors. Run `npm run dev`, open browser:
    1. Verify dark/light theme toggle works, preference persists after refresh
    2. No white flash (FOUC) when loading in dark mode
    3. Drop 5+ images: verify responsive grid layout (resize window to see column changes)
    4. Wait for processing: each card shows correct status badge
    5. After processing: drag the before/after slider on a done image
    6. Toggle transparent/white background: preview updates instantly
    7. Click retry on a failed image: it re-enters the queue
    8. Click remove on an image: it disappears from the grid
    9. Click "Clear all": all images removed
    10. Mobile: open DevTools responsive mode, verify single column layout
  </verify>
  <done>
    - Full App.tsx layout: sticky header with title + controls, main with DropZone + grid, responsive
    - ThemeToggle wired: dark/light toggle with persistence, no FOUC
    - BackgroundToggle wired: transparent/white toggle updates all done previews instantly
    - BatchProgress wired: shows "X of Y processed" with progress bar
    - ImageGrid renders ImageCards with before/after slider for done images
    - ImageCard shows status-appropriate content: waiting, processing (pulse), done (BeforeAfter), error (retry)
    - DropZone adapts: large when empty, compact when images exist, hidden at 100
    - Clear all button removes everything and revokes URLs
    - Smooth animations on card entrance and status transitions
    - crossOriginIsolated debug indicator removed
    - Responsive: works on mobile (1 col), tablet (2 cols), desktop (3+ cols)
    - Professional visual design with dark mode throughout
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete batch processing UI with responsive grid, before/after comparison, background toggle, dark/light theme, and per-image status tracking</what-built>
  <how-to-verify>
    1. Open http://localhost:5173 in browser
    2. **Theme:** Click the theme toggle -- verify dark/light switch. Refresh the page -- verify theme persists (no flash of wrong theme)
    3. **Upload:** Drag-and-drop 5-10 images (mix of JPG and PNG) -- verify they appear in a responsive grid
    4. **Processing:** Watch images process -- verify "Waiting"/"Processing"/"Done" status badges. Verify max 2 process simultaneously.
    5. **Before/After:** On a done image, drag the comparison slider left and right -- verify smooth before/after comparison
    6. **Background toggle:** Switch from "Transparent" to "White" -- verify all done previews switch to white background. Check transparent shows checkerboard.
    7. **Batch progress:** Verify "X of Y processed" progress bar updates correctly
    8. **Responsive:** Resize browser window -- verify grid adapts (1 col narrow, 2-3 cols wide)
    9. **Remove/Clear:** Click remove on one image. Click "Clear all" to remove rest.
    10. **Rejection:** Try dropping a .txt or .pdf file -- verify error message appears
    11. **Mobile:** Open DevTools responsive mode (iPhone/iPad) -- verify usable layout
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 2 complete when ALL success criteria from roadmap are verifiable:

1. **SC-1:** User can drag-and-drop or click-to-browse up to 100 images (PNG, JPG, WebP); unsupported files rejected
   - Test: Drop 100 mixed-format images. Drop a .txt file -- rejected. Drop 101st -- rejected.

2. **SC-2:** Each image shows its own progress state; failed images can be retried individually
   - Test: Process batch, observe per-image status badges. Force error (corrupt file), retry it.

3. **SC-3:** User can toggle transparent/white background and see result update in preview
   - Test: Process an image, toggle background mode, verify preview switches instantly.

4. **SC-4:** User can compare before/after with checkerboard behind transparent areas
   - Test: Process an image in transparent mode, drag the before/after slider, verify checkerboard.

5. **SC-5:** Dark/light theme toggle persists; layout works on desktop, tablet, and mobile
   - Test: Toggle theme, refresh. Resize window to mobile/tablet/desktop widths.
</verification>

<success_criteria>
- All 5 Phase 2 success criteria from ROADMAP.md pass
- Requirements covered: UPLD-01 through UPLD-07, OUT-01, UI-01 through UI-06
- Professional visual design with consistent dark/light mode
- No FOUC on page load
- Responsive grid works across viewport sizes
- Before/after comparison smooth and intuitive
- Batch progress indicator accurate
- No Blob URL memory leaks
</success_criteria>

<output>
After completion, create `.planning/phases/02-batch-ui/02-02-SUMMARY.md`
</output>
