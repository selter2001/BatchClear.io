---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - tsconfig.json
  - tsconfig.app.json
  - tsconfig.node.json
  - index.html
  - public/coi-serviceworker.js
  - src/main.tsx
  - src/index.css
  - src/vite-env.d.ts
  - src/components/App.tsx
  - src/workers/inference.worker.ts
  - src/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "Dev server starts and serves a React page with crossOriginIsolated === true"
    - "Web Worker loads RMBG-1.4 model and forwards download progress events to main thread"
    - "Worker accepts an image Blob, runs inference, and returns mask data via Transferable ArrayBuffer"
    - "Safari detection forces numThreads = 1 to avoid DataCloneError"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite config with React, Tailwind, cross-origin isolation plugins and base URL"
      contains: "crossOriginIsolation"
    - path: "public/coi-serviceworker.js"
      provides: "COOP/COEP header injection for static hosting"
      min_lines: 10
    - path: "index.html"
      provides: "HTML entry with coi-serviceworker script tag before all other scripts"
      contains: "coi-serviceworker.js"
    - path: "src/workers/inference.worker.ts"
      provides: "Pipeline singleton with RMBG-1.4, progress forwarding, inference dispatch"
      min_lines: 50
    - path: "src/lib/types.ts"
      provides: "WorkerInMessage, WorkerOutMessage, ModelStatus, DownloadProgress types"
      exports: ["WorkerInMessage", "WorkerOutMessage", "ModelStatus", "DownloadProgress"]
    - path: "src/components/App.tsx"
      provides: "Root React component skeleton"
      min_lines: 5
  key_links:
    - from: "index.html"
      to: "public/coi-serviceworker.js"
      via: "script tag in head before other scripts"
      pattern: "<script src.*coi-serviceworker"
    - from: "src/workers/inference.worker.ts"
      to: "@huggingface/transformers"
      via: "pipeline() import for background-removal"
      pattern: "pipeline.*background-removal.*briaai/RMBG-1.4"
    - from: "src/workers/inference.worker.ts"
      to: "main thread"
      via: "postMessage with Transferable ArrayBuffer"
      pattern: "postMessage.*\\[.*\\.buffer\\]"
---

<objective>
Scaffold the Vite + React + Tailwind + TypeScript project from scratch and build the Web Worker AI inference pipeline with RMBG-1.4 model loading, download progress reporting, and mask data extraction.

Purpose: This is the foundation of BatchClear.io. The scaffold establishes the build toolchain, cross-origin isolation (required for WASM multithreading), and the AI inference pipeline that all subsequent phases build on. Getting the Worker pipeline right here is the highest-risk, highest-value work in the entire project.

Output: A running dev server with cross-origin isolation verified, and a Web Worker that can load the RMBG-1.4 model, report download progress, accept image blobs, run inference, and return mask data -- all via typed message protocol.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Vite + React + Tailwind + TypeScript project with coi-serviceworker</name>
  <files>
    package.json
    vite.config.ts
    tsconfig.json
    tsconfig.app.json
    tsconfig.node.json
    index.html
    public/coi-serviceworker.js
    src/main.tsx
    src/index.css
    src/vite-env.d.ts
    src/components/App.tsx
  </files>
  <action>
    Create the project from scratch (do NOT use `npm create vite` -- write files directly for full control).

    1. **package.json**: Create with name "batchclear-io", type "module", scripts for dev/build/preview. Dependencies: react, react-dom, @huggingface/transformers. Dev dependencies: vite, @vitejs/plugin-react, typescript, @types/react, @types/react-dom, @tailwindcss/vite, tailwindcss, vite-plugin-cross-origin-isolation.

    2. **vite.config.ts**: Configure with three plugins: react(), tailwindcss(), crossOriginIsolation(). Set `base: "/BatchClear.io/"` for GitHub Pages. Set `worker: { format: "es" }` for ESM worker bundling.

    3. **tsconfig.json**: Project references setup pointing to tsconfig.app.json and tsconfig.node.json.

    4. **tsconfig.app.json**: Target ES2020, lib ["ES2020", "DOM", "DOM.Iterable", "WebWorker"]. Include "src". Enable strict mode, moduleResolution "bundler", jsx "react-jsx". IMPORTANT: Include "WebWorker" in lib array so OffscreenCanvas and self types resolve inside worker files.

    5. **tsconfig.node.json**: For vite.config.ts. Target ES2022, include ["vite.config.ts"].

    6. **index.html**: Standard Vite HTML entry. CRITICAL: Add `<script src="coi-serviceworker.js"></script>` in `<head>` BEFORE the module script. This must be the first script tag. Add meta viewport, charset, title "BatchClear.io".

    7. **public/coi-serviceworker.js**: Download the latest version from the coi-serviceworker npm package. Run: `npm install coi-serviceworker --save-dev` then copy `node_modules/coi-serviceworker/coi-serviceworker.js` to `public/coi-serviceworker.js`. Then remove the package from devDependencies (it's just a static file, not a build dependency).

    8. **src/main.tsx**: Standard React 19 entry: createRoot, render App inside StrictMode.

    9. **src/index.css**: Tailwind v4 setup: `@import "tailwindcss";`. Add a minimal body reset (bg-gray-50, font-sans).

    10. **src/vite-env.d.ts**: Vite client types reference: `/// <reference types="vite/client" />`

    11. **src/components/App.tsx**: Minimal skeleton component that displays "BatchClear.io" heading and a crossOriginIsolated status indicator (green/red dot + text showing `crossOriginIsolated` value). This serves as the visual smoke test.

    Run `npm install` after creating all files. Verify `npx vite build` succeeds with zero errors.
  </action>
  <verify>
    1. `npm install` completes without errors
    2. `npx vite build` produces output in dist/ with zero errors and zero warnings (Tailwind deprecation warnings are OK)
    3. `public/coi-serviceworker.js` exists and contains the service worker code (not empty)
    4. `index.html` has the coi-serviceworker script tag before the module script
    5. `grep -q "crossOriginIsolation" vite.config.ts` confirms the dev plugin is configured
  </verify>
  <done>
    Project scaffold builds cleanly. All config files are correct. coi-serviceworker.js is in public/ and referenced in index.html head. Dev server would show crossOriginIsolated === true (verified in Plan 02 checkpoint). Build produces dist/ output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Web Worker inference pipeline with RMBG-1.4 + typed message protocol</name>
  <files>
    src/lib/types.ts
    src/workers/inference.worker.ts
  </files>
  <action>
    1. **src/lib/types.ts**: Define the complete typed message protocol for Worker communication:

    ```typescript
    // Messages FROM main thread TO worker
    export type WorkerInMessage =
      | { type: "load-model" }
      | { type: "process"; imageId: string; imageData: Blob }

    // Messages FROM worker TO main thread
    export type WorkerOutMessage =
      | { type: "model-progress"; status?: string; name?: string; file?: string;
          progress?: number; loaded?: number; total?: number; task?: string; model?: string }
      | { type: "model-ready" }
      | { type: "model-error"; error: string }
      | { type: "inference-start"; imageId: string }
      | { type: "inference-complete"; imageId: string;
          maskData: { data: Uint8ClampedArray; width: number; height: number; channels: number } }
      | { type: "inference-error"; imageId: string; error: string }

    export type ModelStatus = "idle" | "downloading" | "ready" | "error";

    export type DownloadProgress = {
      loaded: number;
      total: number;
    };
    ```

    Include a "load-model" message type so the main thread can trigger model download proactively (before user drops an image), enabling eager loading for better UX.

    2. **src/workers/inference.worker.ts**: Implement the pipeline singleton pattern from the research:

    - Import `pipeline` and `env` from `@huggingface/transformers`. Set `env.allowLocalModels = false`.
    - Safari detection: Check `navigator.userAgent` for Safari/WebKit (but NOT Chrome/Android). If Safari, set `env.backends.onnx.wasm.numThreads = 1` to avoid DataCloneError. Add a comment explaining WHY (ONNX Runtime issue #11567).
    - `PipelineSingleton` class with static `instance: Promise<any> | null = null` and `getInstance(progressCallback)` method. Use nullish coalescing assignment (`??=`) so the pipeline is created exactly once. Pipeline config: `pipeline("background-removal", "briaai/RMBG-1.4", { dtype: "q8", progress_callback })`.
    - Message handler (`self.addEventListener("message", ...)`) that handles:
      - `"load-model"`: Calls `PipelineSingleton.getInstance()` with progress forwarding. On success, posts `{ type: "model-ready" }`. On error, posts `{ type: "model-error", error: message }`.
      - `"process"`: Ensures model is loaded (calls getInstance), then runs `segmenter(imageData)`. Extracts `output[0]` as RawImage. Posts `{ type: "inference-start" }` before inference. Posts `{ type: "inference-complete", imageId, maskData: { data, width, height, channels } }` with Transferable `[maskData.data.buffer]` for zero-copy transfer. On error, posts `{ type: "inference-error", imageId, error }`.
    - Progress callback: Use optional chaining on ALL fields (`progress?.status`, `progress?.loaded ?? 0`, etc.) per the known bug (GitHub issue #1401). Forward raw progress events to main thread as `{ type: "model-progress", ...progress }`.

    IMPORTANT: The `new URL()` pattern for worker import is NOT created here -- that happens in Plan 02 when wiring the UI. This task only creates the worker file itself and the types.
  </action>
  <verify>
    1. `npx vite build` still succeeds (worker file is valid TypeScript that Vite can bundle)
    2. `src/lib/types.ts` exports WorkerInMessage, WorkerOutMessage, ModelStatus, DownloadProgress
    3. `src/workers/inference.worker.ts` contains: PipelineSingleton class, "background-removal" pipeline, "briaai/RMBG-1.4" model reference, Safari detection with numThreads override, Transferable buffer in postMessage
    4. All progress callback field access uses optional chaining
    5. No imports of @huggingface/transformers outside the worker file
  </verify>
  <done>
    Worker file implements the complete inference pipeline: lazy-loaded singleton, model download progress forwarding with optional chaining safety, Safari WASM thread workaround, image processing with zero-copy Transferable response. Types file defines the full bidirectional message protocol. Build compiles cleanly.
  </done>
</task>

</tasks>

<verification>
Phase-level verification (run after both tasks complete):

1. `npm install && npx vite build` -- clean build with zero errors
2. `public/coi-serviceworker.js` exists and is non-empty
3. `index.html` contains coi-serviceworker script tag before module script
4. `src/workers/inference.worker.ts` references "background-removal" and "briaai/RMBG-1.4"
5. `src/lib/types.ts` defines WorkerInMessage and WorkerOutMessage union types
6. No `@xenova/transformers` imports anywhere (must be `@huggingface/transformers`)
7. Safari numThreads workaround present in worker
</verification>

<success_criteria>
- Project builds with `vite build` producing dist/ output
- Worker file contains complete pipeline singleton with RMBG-1.4
- Typed message protocol covers: model loading, progress, inference request/response, errors
- coi-serviceworker.js properly placed and referenced
- Safari WASM workaround implemented
- Zero imports of @huggingface/transformers on main thread (only in worker)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
